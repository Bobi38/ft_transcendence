version: '3.9'

services:
  mysql:
    image: mysql:8.4
    container_name: mysql
    restart: always
    volumes:
      - ./db/conf.cnf:/etc/mysql/conf.d/my.cnf
      - ./db/conf.sh:/docker-entrypoint-initdb.d/conf.sh
    networks:
      - home
    environment:
      MYSQL_ROOT_PASSWORD_FILE: /run/secrets/data_pswd
      MYSQL_DATABASE: TRANS
      MYSQL_USER: bobi
      MYSQL_PASSWORD: 123
    secrets:
      - data_pswd
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 5s
      timeout: 5s
      retries: 15

  myadmin:
    image: phpmyadmin/phpmyadmin:latest
    container_name: myadmin
    depends_on:
      - mysql
    ports:
      - "8081:80"
    environment:
      PMA_HOST: mysql
      PMA_PORT: 3306
      PMA_USER: bobi
      PMA_PASSWORD: 123
    networks:
      - home
    restart: always

  web:
    build: ./web/
    container_name: web
    depends_on:
      mysql:
        condition: service_healthy
    environment:
      DB_USER: "bobi"
      DB_PASSWORD: 123
      DB_NAME: "TRANS"
      DB_HOST: "mysql"
      DB_PORT:  3306
    volumes:
  # Montre seulement le code frontend pour le live reload
      - ./web/site/go/src:/app/site/go/src:cached
      - ./web/site/go/index.html:/app/site/go/index.html
  # Garde node_modules de l'image
      - /app/site/go/node_modules
    networks:
      - home
    restart: always
    ports:
      - "9000:9000"   # backend Node
      - "5173:5173"   # Vite frontend

secrets:
  data_pswd:
    file: ./secrets/data_pswd

networks:
  home:
    driver: bridge
